-- Criação do database
CREATE DATABASE Projeto;

-- Comando para usar o data base criado
USE Projeto;
 
 -- Criação da tabela usuário
 CREATE TABLE Usuario (
    IdUsuario NUMERIC AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(50),
    Cpf VARCHAR(14),
    DtNasc DATE,
    DtAdm DATE,
    Cargo VARCHAR(25),
    Status VARCHAR(1)
);

-- Criação da tabela produto
CREATE TABLE Produto (
    IdProd NUMERIC AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(50),
    Descricao VARCHAR(50),
    Perecivel VARCHAR(1),
    SKU VARCHAR(10),
    Status VARCHAR(1),
    fk_Categoria_IdCateg NUMERIC,
    fk_Usuario_IdUsuario NUMERIC,
    fk_Fornecedor_IdForne NUMERIC,
    fk_Prod_Est_IdProdEst NUMERIC
);

-- Criando tabela Armazem
CREATE TABLE Armazem (
    IdArmazen NUMERIC AUTO_INCREMENT PRIMARY KEY,
    Rua VARCHAR(10),
    Setor VARCHAR(10),
    Quadra VARCHAR(10),
    PesoMax FLOAT,
    Status VARCHAR(1),
    fk_Prod_Est_IdProdEst NUMERIC
);

-- Criando tabela categoria
CREATE TABLE Categoria (
    IdCateg NUMERIC AUTO_INCREMENT PRIMARY KEY,
    Tipo VARCHAR(10)
);

-- Criando tabela fornecedor
CREATE TABLE Fornecedor (
    IdForne NUMERIC AUTO_INCREMENT PRIMARY KEY,
    Nome VARCHAR(10),
    CNPJ VARCHAR(10),
    DtEntrega DATE
);

-- Criando tabela Prod_Est com a finalidade de definir as relações de N para N entre as tabelas de Produto e Armazem
CREATE TABLE Prod_Est (
    IdProdEst NUMERIC AUTO_INCREMENT PRIMARY KEY,
    DtEntrada DATE,
    DtSaida DATE
);

-- Ativando a relação de FK entre produto e categoria 
ALTER TABLE Produto ADD CONSTRAINT FK_Produto_2
    FOREIGN KEY (fk_Categoria_IdCateg)
    REFERENCES Categoria (IdCateg)
    ON DELETE RESTRICT;

-- Ativando a relação de FK entre produto e usuario 
ALTER TABLE Produto ADD CONSTRAINT FK_Produto_3
    FOREIGN KEY (fk_Usuario_IdUsuario)
    REFERENCES Usuario (IdUsuario)
    ON DELETE RESTRICT;

-- Ativando a relação de FK entre produto e fornecedor 
ALTER TABLE Produto ADD CONSTRAINT FK_Produto_4
    FOREIGN KEY (fk_Fornecedor_IdForne)
    REFERENCES Fornecedor (IdForne)
    ON DELETE RESTRICT;

-- Ativando a relação de FK entre produto e a tabela prod_est 
ALTER TABLE Produto ADD CONSTRAINT FK_Produto_5
    FOREIGN KEY (fk_Prod_Est_IdProdEst)
    REFERENCES Prod_Est (IdProdEst)
    ON DELETE RESTRICT;

-- Ativando a relação de FK entre armazem e prod_est 
ALTER TABLE Armazen ADD CONSTRAINT FK_Armazem_2
    FOREIGN KEY (fk_Prod_Est_IdProdEst)
    REFERENCES Prod_Est (IdProdEst)
    ON DELETE RESTRICT;

-- Adicionando o status de check para definir como 'A' para ativo e 'I' para inativo 
ALTER TABLE Usuario
	ADD CONSTRAINT Status CHECK (Status IN ('A','I'));

-- Adicionando as opções de cargo que o usuário pode ocupar
ALTER TABLE Usuario
	ADD CONSTRAINT Cargo CHECK (Cargo IN ('Administrador','Estoquista','Gerente'));
 
-- Adicionando a coluna para definir a característica do produto de check para definir como 'S' para sim e 'N' para não 
ALTER TABLE Produto 
	ADD CONSTRAINT Perecivel CHECK (Perecivel IN ('S','N'));

-- Adicionando o status de check para definir como 'D' para disponível e 'I' para indisponível    
ALTER TABLE Armazen
	ADD CONSTRAINT Status CHECK (Status IN ('D','I'));

-- Criando tabela de triggers para registro dos eventos ocorridos dentro do banco    
CREATE TABLE LOG (
	ID INT AUTO_INCREMENT PRIMARY KEY,
	NOME_TABELA VARCHAR(50) NOT NULL,
    COLUNA VARCHAR(500) NOT NULL,
	OPERACAO VARCHAR(10) NOT NULL,
    VALOR_ATUAL VARCHAR(500) NOT NULL,
	VALOR_NOVO VARCHAR(500) NOT NULL
);

-- Adicionando as opções de registros para o tipo de operação realizada no banco
ALTER TABLE LOG	
	ADD CONSTRAINT Registros CHECK (OPERACAO IN ('INSERT','UPDATE','DELETE'));
